# Generated by Django 4.2.17 on 2025-08-26 16:01
import json

from django.db import migrations


def migrate_cluster_to_plan(apps, schema_editor):
    """
    将 RabbitMQ 集群配置从 Cluster Django Model 迁移到 Plan config
    背景：
    系统最初将 RabbitMQ 集群信息独立存储在 vendor.models.Cluster
    该实现不符合增强服务的设计，即将配置信息存储在 Plan config
    因此需要将存储在 Cluster Django Model 的集群配置迁移到 Plan config
    """

    # 获取历史模型（避免直接导入当前模型）
    Cluster = apps.get_model('vendor', 'Cluster')
    Plan = apps.get_model('paas_service', 'Plan')

    clusters = list(Cluster.objects.filter(enable=True))
    if not clusters:
        return

    # 将 Cluster 配置转换为 Plan config 格式
    if len(clusters) == 1:
        cluster = clusters[0]
        config = {
            "host": cluster.host,
            "port": cluster.port,
            "management_api": cluster.management_api,
            "admin": cluster.admin,
            "password": cluster.password,
            "version": cluster.version,
        }
        config = json.dumps(config)
    else:
        configs = []
        for cluster in clusters:
            configs.append({
                "host": cluster.host,
                "port": cluster.port,
                "management_api": cluster.management_api,
                "admin": cluster.admin,
                "password": cluster.password,
                "version": cluster.version,
            })
        config = json.dumps({"clusters": configs})

    plans = Plan.objects.filter(name='default')
    for plan in plans:
        # 若 plan config 已配置，则跳过,避免覆盖用户配置
        if plan.config != '{}':
            continue
        plan.config = config
        plan.save(update_fields=["config"])


class Migration(migrations.Migration):
    dependencies = [
        ('vendor', '0002_auto_20191023_0644'),
    ]

    operations = [
        migrations.RunPython(migrate_cluster_to_plan)
    ]
